name: Deploy to VDS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Connect and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /${{ secrets.VDS_USER }}/remyzonk
            
            cat > .env <<EOL
            APP_NAME=Laravel
            APP_ENV=prod
            APP_KEY=${{ secrets.APP_KEY }}
            APP_URL=${{ secrets.APP_URL }}
            
            APP_LOCALE=ru
            APP_FALLBACK_LOCALE=ru
            APP_TIMEZONE=Europe/Moscow
            
            LOG_CHANNEL=stack
            LOG_LEVEL=debug
            
            DB_CONNECTION=pgsql
            DB_HOST=db
            DB_PORT=5432
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            SESSION_DRIVER=database
            SESSION_LIFETIME=120
            
            REDIS_CLIENT=phpredis
            REDIS_HOST=redis
            REDIS_PORT=6379
            
            QUEUE_CONNECTION=database
            CACHE_STORE=database
            
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            EOL
            
            ./deploy.sh
